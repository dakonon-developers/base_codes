<?php
include_once '../../config.php';
require_once '../../db/handler.php';
class User {

	private $table_name;
	private $email;
	private $username;
	private $password;
	private $first_name;
	private $last_name;
	private $password;
	private $auth_token;
	private $address;
	private $genre
	private $_valid;
	private $errors;

    function __construct($params) {
    	$this->table_name = "user";
    	$this->errors = [];
		// validating required fields
		if(isset($params['username']) and isset($params['email']) and isset($params['password'])
			and (filter_var($params["email"], FILTER_VALIDATE_EMAIL)) // if has a valid email
			and $this->has_valid_genre($params['genre']) )
		{
			$password = mysql_escape_mimic($params['password']);
			$this->password = password_hash($password, PASSWORD_DEFAULT, ['cost' => 12]);
			$this->username = mysql_escape_mimic($params['username']);
			$this->email = mysql_escape_mimic($params['email']);
			$this->first_name = mysql_escape_mimic($params['first_name']);
			$this->last_name = mysql_escape_mimic($params['last_name']);
			$this->address = mysql_escape_mimic($params['address']);
			$this->genre = mysql_escape_mimic($params['genre']);
			$this->_valid = True;
		}
	}
	public function has_valid_genre($genre){
		// Validation Genre
		if ($genre != ""){  // if is not empty
		  $valid_genre = false;
		  foreach ($GLOBALS["GENRE_OPTIONS"] as $key => $value) {
		    if ($genre == $value){
			  $valid_genre = true;
			  break;
			} 
	      }
	      if (!$valid_genre){
		    $this->errors.push("Invalid genre");
		  }
		}
		else{
			$valid_genre = true;
		}
		return $valid_genre;
	}

	public function exist_email($email){
		$sql = "SELECT COUNT(*) FROM ".$this->table_name." WHERE email='$email' ";
		$result = $db->con->query($sql);
		echo $result;
		// $result = mysql_query($sql) or die (mysql_error());
		// $result = mysql_fetch_array($result);
		if ((int) $result["COUNT(*)"] > 0){
			return true;
		}
		return false;
	}

	public function create()
	{
		if(!$this->_valid)
		{
			return false;
		}
		else
		{
			$db = new Handler();
			if ($this->exist_email())
				return false;

			$this->auth_token = bin2hex(openssl_random_pseudo_bytes(16));

			$command = 'INSERT INTO '.$this->table_name.' (username, email, password, first_name, last_name, auth_token, address, genre) VALUES ';
			$command .= '("'.$this->username.'","';
			$command .= $this->email.'","';
			$command .= $this->password.'","';
			$command .= $this->first_name.'","';
			$command .= $this->last_name.'","';
			$command .= $this->auth_token.'","';
			$command .= $this->address.'","';
			$command .= $this->genre.'")';

			$r = $db->con->query($command) or die($db->con->error.__LINE__);
			return $r;
		}
	}
	
	
}